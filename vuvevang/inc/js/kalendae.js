/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2012 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.1                                                     *
 ********************************************************************/

(function(){var o,j=function(a,b){a instanceof Element||"string"===typeof a||(b=a);var d=this,e=d.classes,f=d.settings=g.merge(d.defaults,{attachTo:a},b||{}),z=d.container=g.make("div",{"class":e.container}),w=d.calendars=[],j=m().day(f.weekStart),n,k=[],h,l,A;h=[];var o;l=0;n=f.months;for(l=7;l--;)k.push(j.format("ddd").substr(0,f.columnHeaderLength)),j.add("days",1);C(d);if("object"===typeof f.subscribe)for(l in f.subscribe)f.subscribe.hasOwnProperty(l)&&d.subscribe(l,f.subscribe[l]);d._sel=[];
f.selected&&d.setSelected(f.selected,!1);n=f.viewStartDate?m(f.viewStartDate,f.format):0<d._sel.length?m(d._sel[0]):m();d.viewStartDate=n.date(1);if("function"===typeof f.blackout)d.blackout=f.blackout;else if(f.blackout){var u=B(f.blackout,f.parseSplitDelimiter);d.blackout=function(a){a=m(a).hours(0).minutes(0).seconds(0).milliseconds(0).valueOf();if(1>a||!d._sel||1>d._sel.length)return!1;for(var b=u.length;b--;)if(u[b].valueOf()===a)return!0;return!1}}else d.blackout=function(){return!1};d.direction=
d.directions[f.direction]?d.directions[f.direction]:d.directions.any;for(n=Math.max(f.months,1);n--;){h=g.make("div",{"class":e.calendar},z);h.setAttribute("data-cal-index",n);1<f.months&&(n==Math.max(f.months-1,1)?g.addClassName(h,e.monthFirst):0===n?g.addClassName(h,e.monthLast):g.addClassName(h,e.monthMiddle));l=g.make("div",{"class":e.title},h);g.make("a",{"class":e.previous},l);g.make("a",{"class":e.next},l);j=g.make("span",{"class":e.caption},l);A=g.make("div",{"class":e.header},h);l=0;do o=
g.make("span",{},A),o.innerHTML=k[l];while(7>++l);A=g.make("div",{"class":e.days},h);l=0;for(h=[];42>l++;)h.push(g.make("span",{},A));w.push({caption:j,days:h});n&&g.make("div",{"class":e.monthSeparator},z)}d.draw();g.addEvent(z,"mousedown",function(a,b){var h;if(g.hasClassName(b,e.next))!1!==d.publish("view-changed",d,["next"])&&(d.viewStartDate.add("months",1),d.draw());else if(g.hasClassName(b,e.previous))!1!==d.publish("view-changed",d,["previous"])&&(d.viewStartDate.subtract("months",1),d.draw());
else if(g.hasClassName(b.parentNode,e.days)&&g.hasClassName(b,e.dayActive)&&(h=b.getAttribute("data-date")))if(h=m(h,f.dayAttributeFormat),!1!==d.publish("date-clicked",d,[h]))switch(f.mode){case "multiple":d.addSelected(h)||d.removeSelected(h);break;case "range":d.addSelected(h);break;default:d.addSelected(h)}return!1});(f.attachTo=g.$(f.attachTo))&&f.attachTo.appendChild(z)};j.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",viewStartDate:null,blackout:null,selected:null,
mode:"single",format:null,subscribe:null,columnHeaderLength:2,titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",parseSplitDelimiter:/,\s*|\s*-\s*/,rangeDelimiter:" - ",multipleDelimiter:", ",dateClassMap:{}},classes:{container:"kalendae",calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",monthLast:"k-last-month",title:"k-title",previous:"k-previous",next:"k-next",caption:"k-caption",header:"k-header",days:"k-days",dayOutOfMonth:"k-out-of-month",
dayActive:"k-active",daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator"},directions:{past:function(a){return m(a).valueOf()>=o.valueOf()},"today-past":function(a){return m(a).valueOf()>o.valueOf()},any:function(){return!1},"today-future":function(a){return m(a).valueOf()<o.valueOf()},future:function(a){return m(a).valueOf()<=o.valueOf()}},getSelectedAsDates:function(){for(var a=[],b=0,d=this._sel.length;b<d;b++)a.push(this._sel[b].nativeDate());return a},
getSelectedAsText:function(a){for(var b=[],d=0,e=this._sel.length;d<e;d++)b.push(this._sel[d].format(a||this.settings.format||"YYYY-MM-DD"));return b},getSelectedRaw:function(){for(var a=[],b=0,d=this._sel.length;b<d;b++)a.push(m(this._sel[b]));return a},getSelected:function(a){a=this.getSelectedAsText(a);switch(this.settings.mode){case "range":return a.splice(2),a.join(this.settings.rangeDelimiter);case "multiple":return a.join(this.settings.multipleDelimiter);default:return a[0]}},isSelected:function(a){a=
m(a).hours(0).minutes(0).seconds(0).milliseconds(0).valueOf();if(1>a||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case "range":var b=this._sel[0]?this._sel[0].valueOf():0,d=this._sel[1]?this._sel[1].valueOf():0;return b===a||d===a?1:!b||!d?0:a>b&&a<d||b<d&&a<b&&a>d?-1:!1;case "multiple":for(b=this._sel.length;b--;)if(this._sel[b].valueOf()===a)return!0;return!1;default:return this._sel[0]&&this._sel[0].valueOf()===a}},setSelected:function(a,b){this._sel=B(a,this.settings.parseSplitDelimiter,
this.settings.format);this._sel.sort(function(a,b){return a.valueOf()-b.valueOf()});!1!==b&&this.draw()},addSelected:function(a,b){a=m(a).hours(0).minutes(0).seconds(0).milliseconds(0);switch(this.settings.mode){case "multiple":if(this.isSelected(a))return!1;this._sel.push(a);break;case "range":1!==this._sel.length?this._sel=[a]:a.valueOf()>this._sel[0].valueOf()?this._sel[1]=a:this._sel=[a,this._sel[0]];break;default:this._sel=[a]}this._sel.sort(function(a,b){return a.valueOf()-b.valueOf()});this.publish("change",
this);!1!==b&&this.draw();return!0},removeSelected:function(a,b){for(var a=m(a).hours(0).minutes(0).seconds(0).milliseconds(0).valueOf(),d=this._sel.length;d--;)if(this._sel[d].valueOf()===a)return this._sel.splice(d,1),this.publish("change",this),!1!==b&&this.draw(),!0;return!1},draw:function(){var a=m(this.viewStartDate),b,d=this.classes,e,f,g,j=0,x,n=0,k,h=this.settings;x=this.calendars.length;(b={past:x-1,"today-past":x-1,any:2<x?Math.floor(x/2):0,"today-future":0,future:0}[this.settings.direction])&&
(a=a.subtract({M:b}));do{b=m(a).date(1);b.day(b.day()<this.settings.weekStart?this.settings.weekStart-7:this.settings.weekStart);e=this.calendars[j];e.caption.innerHTML=a.format(this.settings.titleFormat);n=0;do f=e.days[n],g=[],(k=this.isSelected(b))&&g.push({"-1":d.dayInRange,1:d.daySelected,"true":d.daySelected}[k]),b.month()!=a.month()?g.push(d.dayOutOfMonth):(!this.blackout(b)&&!this.direction(b)||0<k)&&g.push(d.dayActive),0===Math.floor(o.diff(b,"days",!0))&&g.push(d.dayToday),k=b.format(this.settings.dayAttributeFormat),
h.dateClassMap[k]&&g.push(h.dateClassMap[k]),f.innerHTML=b.format(h.dayNumberFormat),f.className=g.join(" "),f.setAttribute("data-date",k),b.add("days",1);while(42>++n);a.add("months",1)}while(++j<x)}};var B=function(a,b,d){var e=[];"string"===typeof a?a=a.split(b):g.isArray(a)||(a=[a]);c=a.length;i=0;do a[i]&&e.push(m(a[i],d).hours(0).minutes(0).seconds(0).milliseconds(0));while(++i<c);return e};window.Kalendae=j;var g=j.util={$:function(a){return"string"==typeof a?document.getElementById(a):a},
$$:function(a){return document.querySelectorAll(a)},make:function(a,b,d){var e,a=document.createElement(a);if(b)for(e in b)b.hasOwnProperty(e)&&a.setAttribute(e,b[e]);d&&d.appendChild(a);return a},isVisible:function(a){return 0<a.offsetWidth||0<a.offsetHeight},domReady:function(a){/in/.test(document.readyState)?setTimeout(function(){g.domReady(a)},9):a()},addEvent:function(a,b,d){var e=function(b){var b=b||window.event,e=d.apply(a,[b,b.target||b.srcElement]);!1===e&&(b.preventDefault?b.preventDefault():
(b.returnValue=!1,b.cancelBubble=!0));return e};a.attachEvent?a.attachEvent("on"+b,e):a.addEventListener(b,e,!1);return e},removeEvent:function(a,b,d){a.detachEvent?a.detachEvent("on"+b,d):a.removeEventListener(b,d,!1)},hasClassName:function(a,b){if(!(a=g.$(a)))return!1;var d=a.className;return 0<d.length&&(d==b||RegExp("(^|\\s)"+b+"(\\s|$)").test(d))},addClassName:function(a,b){if((a=g.$(a))&&!g.hasClassName(a,b))a.className+=(a.className?" ":"")+b},removeClassName:function(a,b){if(a=g.$(a))a.className=
g.trimString(a.className.replace(RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))},getPosition:function(a,b){var d=a.offsetLeft,e=a.offsetTop,f={};if(!b)for(;a=a.offsetParent;)d+=a.offsetLeft,e+=a.offsetTop;f[0]=f.left=d;f[1]=f.top=e;return f},getHeight:function(a){return a.offsetHeight||a.scrollHeight},getWidth:function(a){return a.offsetWidth||a.scrollWidth},trimString:function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var a=!0===arguments[0],b={},d=a?1:0;d<arguments.length;d++){var e=
b,f=arguments[d];if("object"===typeof f){var g=void 0;for(g in f)f.hasOwnProperty(g)&&(a&&"object"===typeof e[g]&&"object"===typeof f[g]?_update(e[g],f[g]):e[g]=f[g])}}return b},isArray:function(a){return!(!a||!a.length||0===a.length||"object"!==typeof a||!a.constructor||a.nodeType||a.item)}};j.util.domReady(function(){for(var a=g.$$(".auto-kal"),b=a.length,d;b--;)d=a[b],"INPUT"===d.tagName?new j.Input(d):new j({attachTo:d})});j.Input=function(a,b){var d=this.input=g.$(a),e;if(!d||"INPUT"!==d.tagName)throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";
var f=this,m=f.classes;opts=f.settings=g.merge(f.defaults,b);opts.attachTo=window.document.body;opts.selected?e=!0:opts.selected=d.value;j.call(f,opts);e&&(d.value=f.getSelected());e=f.container;var w=!1;e.style.display="none";g.addClassName(e,m.positioned);g.addEvent(e,"mousedown",function(){w=true});g.addEvent(window.document,"mousedown",function(){w=false});g.addEvent(d,"focus",function(){f.setSelected(this.value);f.show()});g.addEvent(d,"blur",function(){if(w){w=false;d.focus()}else f.hide()});
g.addEvent(d,"keyup",function(){f.setSelected(this.value)});f.subscribe("change",function(){d.value=f.getSelected()})};j.Input.prototype=g.merge(j.prototype,{defaults:g.merge(j.prototype.defaults,{format:"MM/DD/YYYY",side:"bottom",offsetLeft:0,offsetTop:0}),classes:g.merge(j.prototype.classes,{positioned:"k-floating"}),show:function(){var a=this.container,b=a.style,d=this.input,e=g.getPosition(d);b.display="";switch(opts.side){case "left":b.left=e.left-g.getWidth(a)+this.settings.offsetLeft+"px";
b.top=e.top+this.settings.offsetTop+"px";break;case "right":b.left=e.left+g.getWidth(d)+"px";b.top=e.top+this.settings.offsetTop+"px";break;case "top":b.left=e.left+this.settings.offsetLeft+"px";b.top=e.top-g.getHeight(a)+this.settings.offsetTop+"px";break;default:b.left=e.left+this.settings.offsetLeft+"px",b.top=e.top+g.getHeight(d)+this.settings.offsetTop+"px"}},hide:function(){this.container.style.display="none"}});var C=function(a){a||(a=this);var b=a.c_||{};a.publish=function(a,e,f){for(var g=
(a=b[a])?a.length:0,j;g--;)if(j=a[g].apply(e,f||[]),"boolean"===typeof j)return j};a.subscribe=function(a,e,f){b[a]||(b[a]=[]);f?b[a].push(e):b[a].unshift(e);return[a,e]};a.unsubscribe=function(a){for(var e=b[a[0]],a=a[1],f=e?e.length:0;f--;)e[f]===a&&e.splice(f,1)}},m=j.moment=function(a,b){function d(a){this._d=a}function e(a,b){for(var d=a+"";d.length<b;)d="0"+d;return d}function f(b,d,e,f){var g="string"===typeof d,h=g?{}:d;g&&f&&(h[d]=f);d=(h.ms||h.milliseconds||0)+1E3*(h.s||h.seconds||0)+6E4*
(h.m||h.minutes||0)+36E5*(h.h||h.hours||0);f=(h.d||h.days||0)+7*(h.w||h.weeks||0);h=(h.M||h.months||0)+12*(h.y||h.years||0);d&&b.setTime(+b+d*e);f&&b.setDate(b.getDate()+f*e);h&&(d=b.getDate(),b.setDate(1),b.setMonth(b.getMonth()+h*e),b.setDate(Math.min((new a(b.getFullYear(),b.getMonth()+1,0)).getDate(),d)));return b}function g(b){return new a(b[0],b[1]||0,b[2]||1,b[3]||0,b[4]||0,b[5]||0,b[6]||0)}function j(b,f){function g(d){var f;switch(d){case "M":return t+1;case "Mo":return t+1+o(t+1);case "MM":return e(t+
1,2);case "MMM":return h.monthsShort[t];case "MMMM":return h.months[t];case "D":return l;case "Do":return l+o(l);case "DD":return e(l,2);case "DDD":return d=new a(m,t,l),f=new a(m,0,1),~~((d-f)/864E5+1.5);case "DDDo":return d=g("DDD"),d+o(d);case "DDDD":return e(g("DDD"),3);case "d":return q;case "do":return q+o(q);case "ddd":return h.weekdaysShort[q];case "dddd":return h.weekdays[q];case "w":return d=new a(m,t,l-q+5),f=new a(d.getFullYear(),0,4),~~((d-f)/864E5/7+1.5);case "wo":return d=g("w"),d+
o(d);case "ww":return e(g("w"),2);case "YY":return e(m%100,2);case "YYYY":return m;case "a":return 11<r?k.pm:k.am;case "A":return 11<r?k.PM:k.AM;case "H":return r;case "HH":return e(r,2);case "h":return r%12||12;case "hh":return e(r%12||12,2);case "m":return n;case "mm":return e(n,2);case "s":return F;case "ss":return e(F,2);case "zz":case "z":return(b.toString().match(H)||[""])[0].replace(G,"");case "Z":return(0<p?"+":"-")+e(~~(Math.abs(p)/60),2)+":"+e(~~(Math.abs(p)%60),2);case "ZZ":return(0<p?
"+":"-")+e(~~(10*Math.abs(p)/6),4);case "L":case "LL":case "LLL":case "LLLL":case "LT":return j(b,h.longDateFormat[d]);default:return d.replace(/(^\[)|(\\)|\]$/g,"")}}var s=new d(b),t=s.month(),l=s.date(),m=s.year(),q=s.day(),r=s.hours(),n=s.minutes(),F=s.seconds(),p=s.zone(),o=h.ordinal,k=h.meridiem;return f.replace(C,g)}function m(b,d){var e=[0,0,1,0,0,0,0],f=0,l=0,j=!1,o=b.match(D),q=d.match(I),r,n;for(r=0;r<q.length;r++){var k=o[r],p=void 0;switch(q[r]){case "M":case "MM":e[1]=~~k-1;break;case "MMM":case "MMMM":for(p=
0;12>p;p++)if(h.monthsParse[p].test(k)){e[1]=p;break}break;case "D":case "DD":case "DDD":case "DDDD":e[2]=~~k;break;case "YY":k=~~k;e[0]=k+(70<k?1900:2E3);break;case "YYYY":e[0]=~~Math.abs(k);break;case "a":case "A":n="pm"===k.toLowerCase();break;case "H":case "HH":case "h":case "hh":e[3]=~~k;break;case "m":case "mm":e[4]=~~k;break;case "s":case "ss":e[5]=~~k;break;case "Z":case "ZZ":j=!0,p=k.match(J),p[1]&&(f=~~p[1]),p[2]&&(l=~~p[2]),"-"===p[0]&&(f=-f,l=-l)}}n&&12>e[3]&&(e[3]+=12);!1===n&&12===e[3]&&
(e[3]=0);e[3]+=f;e[4]+=l;return j?new a(a.UTC.apply({},e)):g(e)}function n(a,b,d){var e=h.relativeTime[a];return"function"===typeof e?e(b||1,!!d,a):e.replace(/%d/i,b||1)}function k(a,b){h.fn[a]=function(a){return null!=a?(this._d["set"+b](a),this):this._d["get"+b]()}}var h,l=Math.round,o={},B="undefined"!==typeof module,u="months,monthsShort,monthsParse,weekdays,weekdaysShort,longDateFormat,calendar,relativeTime,ordinal,meridiem".split(","),v,C=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|dddd?|do?|w[o|w]?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|zz?|ZZ?|LT|LL?L?L?)/g,
G=/[^A-Z]/g,H=/\([A-Za-z ]+\)|:[0-9]{2} [A-Z]{3} /g,I=/(\\)?(MM?M?M?|dd?d?d|DD?D?D?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|ZZ?|T)/g,D=/(\\)?([0-9]+|([a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+|([\+\-]\d\d:?\d\d))/gi,J=/([\+\-]|\d\d)/gi,E="Month,Date,Hours,Minutes,Seconds,Milliseconds".split(",");h=function(e,f){if(null===e)return null;var h;if(e&&e._d instanceof a)h=new a(+e._d);else if(f)if("[object Array]"===Object.prototype.toString.call(f)){var l=e.match(D),k=99,n,o,q;for(n=0;n<f.length;n++){o=m(e,
f[n]);q=l;for(var r=j(o,f[n]).match(D),u=Math.min(q.length,r.length),v=Math.abs(q.length-r.length),p=0,y=void 0,y=0;y<u;y++)~~q[y]!==~~r[y]&&p++;q=p+v;q<k&&(k=q,h=o)}}else h=m(e,f);else h=e===b?new a:e instanceof a?e:"[object Array]"===Object.prototype.toString.call(e)?g(e):new a(e);return new d(h)};h.version="1.3.0";h.lang=function(a,b){var d,e;e=[];if(b){for(d=0;12>d;d++)e[d]=RegExp("^"+b.months[d]+"|^"+b.monthsShort[d].replace(".",""),"i");b.monthsParse=b.monthsParse||e;o[a]=b}if(o[a])for(d=0;d<
u.length;d++)e=u[d],h[e]=o[a][e]||h[e];else B&&(d=require("./lang/"+a),h.lang(a,d))};h.lang("en",{months:"January,February,March,April,May,June,July,August,September,October,November,December".split(","),monthsShort:"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(","),weekdays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(","),weekdaysShort:"Sun,Mon,Tue,Wed,Thu,Fri,Sat".split(","),longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},
meridiem:{AM:"AM",am:"am",PM:"PM",pm:"pm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(a){var b=a%10;return 1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th"}});h.fn=d.prototype=
{clone:function(){return h(this)},valueOf:function(){return+this._d},nativeDate:function(){return this._d},toString:function(){return this._d.toString()},toDate:function(){return this._d},format:function(a){return j(this._d,a)},add:function(a,b){this._d=f(this._d,a,1,b);return this},subtract:function(a,b){this._d=f(this._d,a,-1,b);return this},diff:function(a,b,d){var e=h(a),a=this._d-e._d,f=this.year()-e.year(),g=this.month()-e.month(),e=this.day()-e.day(),b="months"===b?12*f+g+e/30:"years"===b?
f+g/12:"seconds"===b?a/1E3:"minutes"===b?a/6E4:"hours"===b?a/36E5:"days"===b?a/864E5:"weeks"===b?a/6048E5:"days"===b?a/3600:a;return d?b:l(b)},from:function(a,b){var d=this.diff(a),e=h.relativeTime,f;f=l(Math.abs(d)/1E3);var g=l(f/60),k=l(g/60),j=l(k/24),m=l(j/365);f=45>f&&["s",f]||1===g&&["m"]||45>g&&["mm",g]||1===k&&["h"]||22>k&&["hh",k]||1===j&&["d"]||25>=j&&["dd",j]||45>=j&&["M"]||345>j&&["MM",l(j/30)]||1===m&&["y"]||["yy",m];f[2]=b;f=n.apply({},f);return b?f:(0>=d?e.past:e.future).replace(/%s/i,
f)},fromNow:function(a){return this.from(h(),a)},calendar:function(){var a=h(),a=this.diff(h([a.year(),a.month(),a.date()]),"days",!0),b=h.calendar,d=b.sameElse,a=-6>a?d:-1>a?b.lastWeek:0>a?b.lastDay:1>a?b.sameDay:2>a?b.nextDay:7>a?b.nextWeek:d;return this.format("function"===typeof a?a.apply(this):a)},isLeapYear:function(){var a=this.year();return 0===a%4&&0!==a%100||0===a%400},isDST:function(){return this.zone()!==h([this.year()]).zone()},day:function(a){var b=this._d.getDay();return null==a?b:
this.add({d:a-b})}};for(v=0;v<E.length;v++)k(E[v].toLowerCase(),E[v]);k("year","FullYear");h.fn.zone=function(){return this._d.getTimezoneOffset()};return h}(Date);o=m().hours(0).minutes(0).seconds(0).milliseconds(0);"undefined"!==typeof jQuery&&(jQuery.fn.kalendae=function(a){this.each(function(b,d){"INPUT"===d.tagName?$(d).data("kalendae",new j.Input(d,a)):$(d).data("kalendae",new j($.extend({},{attachTo:d},a)))});return this})})();
